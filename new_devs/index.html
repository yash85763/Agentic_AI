# templates/index.html

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Highcharts Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="/static/icon/favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* A very light gray, almost white */
        }

        #output-iframe {
            width: 100%;
            height: 100%;
            border: 1px solid #e2e8f0; /* Lighter border */
            border-radius: 0.5rem;
        }

        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-success {
            background-color: #dcfce7; /* Green-100 */
            color: #166534; /* Green-800 */
        }

        .toast-error {
            background-color: #fee2e2; /* Red-100 */
            color: #991b1b; /* Red-800 */
        }
        
        .toast-info {
             background-color: #e0f2fe; /* Sky-100 */
             color: #075985; /* Sky-800 */
        }

        .toast svg {
            flex-shrink: 0;
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.75rem;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl h-screen flex flex-col">

        <main id="output-section" class="flex-grow overflow-y-auto hidden">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-full flex flex-col">
                <div class="flex-shrink-0 flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">Generated Chart</h2>
                    <button id="save-html-btn" class="bg-blue-600 text-white font-semibold py-1.5 px-3 rounded-lg hover:bg-blue-700 flex items-center text-sm transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                        Save as HTML
                    </button>
                </div>
                <div class="flex-grow">
                    <iframe id="output-iframe" title="Generated Highcharts Chart"></iframe>
                </div>
            </div>
        </main>

        <main id="placeholder-section" class="flex-grow flex items-center justify-center">
            <div class="text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-24 w-24 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />
                </svg>
                <h2 class="mt-4 text-2xl font-bold text-gray-600">Your chart will appear here</h2>
                <p class="text-gray-500">Enter a description below and click the send button to get started.</p>
            </div>
        </main>

        <footer class="flex-shrink-0 pt-4">
             <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                <div class="flex items-center space-x-4">
                    <div class="relative flex-grow">
                        <textarea id="prompt-input" rows="3" class="w-full p-3 pr-16 border border-gray-300 bg-white text-gray-900 rounded-lg focus:ring-2 focus:ring-indigo-500 transition-shadow duration-200 resize-none placeholder-gray-500" placeholder="e.g., A donut chart of top 5 car manufacturers"></textarea>
                        <button id="generate-btn" class="absolute right-3 top-1/2 -translate-y-1/2 bg-indigo-600 text-white font-semibold p-2 rounded-lg hover:bg-indigo-700 flex items-center justify-center transition-colors disabled:bg-indigo-400 disabled:cursor-not-allowed">
                            <span id="btn-text" class="hidden">Generate</span> 
                            <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                            </svg>
                            <svg id="loader" class="animate-spin h-6 w-6 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                    </div>
                    <button id="reset-btn" class="bg-red-600 text-white font-semibold p-2 rounded-lg hover:bg-red-700 flex items-center justify-center transition-colors disabled:bg-red-400 disabled:cursor-not-allowed" title="Reset Conversation Memory">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4 9a9 9 0 0114.13-6.364M20 15a9 9 0 01-14.13 6.364" />
                        </svg>
                    </button>
                </div>
            </div>
             <p id="generation-notice" class="text-xs text-gray-500 text-center mt-2 hidden">
                Chart generation can sometimes take over a minute. Please be patient.
             </p>
        </footer>
        
        <div id="error-message" class="mt-8 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative hidden" role="alert">
            <strong class="font-bold">Error:</strong> <span class="block sm:inline" id="error-text"></span>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const generateBtn = document.getElementById('generate-btn');
            const resetBtn = document.getElementById('reset-btn');
            const btnText = document.getElementById('btn-text');
            const loader = document.getElementById('loader');
            const sendIcon = document.getElementById('send-icon');
            const promptInput = document.getElementById('prompt-input');
            const outputSection = document.getElementById('output-section');
            const placeholderSection = document.getElementById('placeholder-section');
            const outputIframe = document.getElementById('output-iframe');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const generationNotice = document.getElementById('generation-notice');
            const toastContainer = document.getElementById('toast-container');

            // --- State Variables ---
            let sessionId = uuidv4();
            const MAX_ATTEMPTS = 3; 
            const POLLING_INTERVAL = 2500; 

            // --- Toast Notification Function ---
            const showToast = (message, type = 'info', duration = 3000) => {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                
                let icon;
                if (type === 'success') {
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                } else if (type === 'error') {
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`;
                } else {
                    icon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                }
                toast.innerHTML = `${icon}<span>${message}</span>`;
                toastContainer.appendChild(toast);

                // Animate in
                setTimeout(() => toast.classList.add('show'), 10);

                // Animate out and remove
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            };

            // --- Core Functions ---
            const setLoadingState = (isLoading, message = 'Generate Chart') => {
                generateBtn.disabled = isLoading;
                resetBtn.disabled = isLoading;
                promptInput.disabled = isLoading;
                
                loader.classList.toggle('hidden', !isLoading);
                sendIcon.classList.toggle('hidden', isLoading);

                btnText.textContent = message; 
            };

            const handleSuccess = (result) => {
                generationNotice.classList.add('hidden');
                const generatedHtmlContent = result.html_code;
                const originalPrompt = result.original_prompt;

                if (!generatedHtmlContent || generatedHtmlContent.trim() === '') {
                     handleFinalError(new Error('Generation failed: The model returned an empty response.'));
                     return;
                }
                
                placeholderSection.classList.add('hidden');
                outputSection.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                outputIframe.onload = () => {
                    outputIframe.contentWindow.onerror = null; 
                    outputIframe.contentWindow.onerror = (message, source, lineno, colno, error) => {
                        console.error("Error in generated chart:", error);
                        const errorDetails = error ? error.stack : message;
                        runGeneration(originalPrompt, errorDetails, 2);
                        return true;
                    };
                };

                outputIframe.srcdoc = generatedHtmlContent;
                
                document.getElementById('save-html-btn').onclick = () => {
                    saveAsHtml(generatedHtmlContent);
                    showToast('Chart saved as HTML.', 'success');
                };
                
                setLoadingState(false);
                showToast('Chart generated successfully!', 'success');
            };

            const handleFinalError = (finalError) => {
                generationNotice.classList.add('hidden');
                errorText.textContent = finalError.message;
                errorMessage.classList.remove('hidden');
                setLoadingState(false);
                showToast('An error occurred during generation.', 'error');
            };
            
            const pollForResult = (taskId) => {
                let pollingAttempts = 0;
                const maxPollingAttempts = 80;

                const intervalId = setInterval(async () => {
                    pollingAttempts++;

                    if (pollingAttempts > 20 && pollingAttempts <= 50) { 
                        setLoadingState(true, 'Still working, this can take a moment...');
                    } else if (pollingAttempts > 50) {
                         setLoadingState(true, 'Almost there, generating complex chart...');
                    }

                    if (pollingAttempts > maxPollingAttempts) {
                        clearInterval(intervalId);
                        handleFinalError(new Error('Task timed out. The server took too long to respond.'));
                        return;
                    }
                    try {
                        const response = await fetch(`/api/status/${taskId}`);
                        if (!response.ok) {
                             if (response.status === 404 && pollingAttempts > 3) {
                                 clearInterval(intervalId);
                                 throw new Error('Task could not be found on the server.');
                             }
                            return;
                        }
                        
                        const data = await response.json();
                        if (data.status === 'SUCCESS') {
                            clearInterval(intervalId);
                            handleSuccess(data.result);
                        } else if (data.status === 'FAILED') {
                            clearInterval(intervalId);
                            throw new Error(data.result.detail || 'The generation task failed unexpectedly.');
                        }
                    } catch (error) {
                        clearInterval(intervalId);
                        handleFinalError(error);
                    }
                }, POLLING_INTERVAL);
            };

            const runGeneration = async (prompt, errorFeedback = null, attempt = 1) => {
                if (attempt > MAX_ATTEMPTS) {
                    handleFinalError(new Error(`Failed to fix the chart after ${MAX_ATTEMPTS} attempts. Please try rephrasing your request.`));
                    return;
                }
                
                const loadingMessage = errorFeedback 
                    ? `Error detected. Attempting to fix... (Attempt ${attempt}/${MAX_ATTEMPTS})` 
                    : 'Generating...';
                setLoadingState(true, loadingMessage);
                errorMessage.classList.add('hidden');
                try {
                    const formData = new FormData();
                    formData.append('prompt', prompt);
                    formData.append('session_id', sessionId);
                    if (errorFeedback) {
                        formData.append('error_feedback', errorFeedback);
                    }

                    const response = await fetch('/api/generate', { method: 'POST', body: formData });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: 'An unknown server error.' }));
                        throw new Error(errorData.detail || 'Failed to start the generation task.');
                    }
                    const data = await response.json();
                    pollForResult(data.task_id);
                } catch(fetchError) {
                    handleFinalError(fetchError);
                }
            };
            
            generateBtn.addEventListener('click', () => {
                const userPrompt = promptInput.value.trim();
                if (!userPrompt) {
                    showToast('Please enter a chart description.', 'info');
                    return;
                }
                
                generationNotice.classList.remove('hidden');
                
                runGeneration(userPrompt, null, 1);
            });

            resetBtn.addEventListener('click', async () => {
                const formData = new FormData();
                formData.append('session_id', sessionId);
                try {
                    const response = await fetch('/api/reset', { method: 'POST', body: formData });
                    if(response.ok) {
                        showToast("Conversation memory has been reset.", 'success');
                        promptInput.value = "";
                        outputSection.classList.add('hidden');
                        placeholderSection.classList.remove('hidden');
                    } else {
                        showToast("Failed to reset memory.", 'error');
                    }
                } catch (error) {
                    console.error("Error resetting memory:", error);
                    showToast("An error occurred while resetting the memory.", 'error');
                }
            });
            // --- Utility Functions ---
            function saveAsHtml(htmlContent) {
                if (!htmlContent) return;
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'chart.html';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
            
            // Simple UUID generator for session tracking
            function uuidv4() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
        });
    </script>
</body>
</html>